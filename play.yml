- hosts: 127.0.0.1
  connection: local
  vars:
    workstation: false
    full_name: "Petr Horáček"
    email: "phoracek@redhat.com"
  tasks:
  - name: Collect non-root username
    shell: whoami
    register: whoami_result
# -- Git -----------------------------------------------------------------------
  - name: Git
    block:
    - name: Install Git
      dnf:
        name: git
        state: present
      become: true
    - name: Configure global variables
      git_config:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        scope: global
      with_items:
        - { name: "user.name",  value: "{{ full_name }}" }
        - { name: "user.email", value: "{{ email }}" }
        - { name: "pull.ff", value: "only" }
# -- Zsh -----------------------------------------------------------------------
  - name: Zsh
    block:
    - name: Install Zsh
      dnf:
        name: zsh
        state: present
      become: true
    - name: Install oh-my-zsh
      git:
        repo: https://github.com/robbyrussell/oh-my-zsh.git
        dest: ~/.oh-my-zsh
    - name: Configure Zsh
      copy:
        src: ./zsh/zshrc
        dest: ~/.zshrc
    - name: Install zsh profile
      copy:
        src: ./zsh/zprofile
        dest: ~/.zprofile
    - name: Initialize profile directory
      file:
        path: ~/.zprofile.d
        state: directory
    - name: Install custom theme for workstation
      copy:
        src: ./zsh/petr-workstation.zsh-theme
        dest: ~/.oh-my-zsh/themes/petr.zsh-theme
      when: workstation
    - name: Install custom theme for server
      copy:
        src: ./zsh/petr-server.zsh-theme
        dest: ~/.oh-my-zsh/themes/petr.zsh-theme
      when: not workstation
    - name: Set Zsh as the default shell
      user:
        name: "{{ whoami_result.stdout }}"
        shell: /usr/bin/zsh
      become: true
# -- Go ------------------------------------------------------------------------
# -- C -------------------------------------------------------------------------
  - name: C
    block:
    - name: Install C Development Tools and Libraries
      shell: dnf groupinstall -y "C Development Tools And Libraries"
      become: true
# -- Rust ----------------------------------------------------------------------
  - name: Rust
    block:
    - name: Install gcc for rust libraries
      dnf:
        name: gcc
        state: present
      become: true
    - name: Install Rust and Cargo
      shell: curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
# -- Virtualization ------------------------------------------------------------
  - name: Virtualization
    when: workstation
    block:
    - name: Install virt-manager
      dnf:
        name: virt-manager
        state: present
      become: true
    - name: Add user to the libvirt group
      user:
        name: "{{ whoami_result.stdout }}"
        group: libvirt
      become: true
# -- Development VM ------------------------------------------------------------
    # Configure it so non-root can access VMs and share a private directory with them
    #- name: Vagrant
    #- name: Development VM
# -- KubeVirt ------------------------------------------------------------------
# setup KubeVirt development machine
# maybe vagrant?
# -- Sway ----------------------------------------------------------------------
  - name: Sway
    when: workstation
    block:
    - name: Install Sway module
      command: dnf module install -y sway/full
      become: true
    - name: Fix Sway by adding sticky bit to its binary
      file:
        path: /usr/bin/sway
        state: file
        mode: u+s,g+s,o+s
      become: true
    - name: Initialize sway configuration directory
      file:
        path: ~/.config/sway
        state: directory
    - name: Set Sway configuration
      copy:
        src: ./sway/config
        dest: ~/.config/sway/config
    - name: Set Sway status bar
      copy:
        src: ./sway/status.sh
        dest: ~/.config/sway/status.sh
        mode: u+x
    - name: Start sway when logging in
      copy:
        src: ./sway/profile
        dest: ~/.zprofile.d/sway
    - name: Build the backlight executable
      command: ~/.cargo/bin/rustc ./sway/backlight.rs -o /tmp/backlight
    - name: Move backlight under PATH, set root as the owner of backlight and enable sticky bit
      copy:
        src: /tmp/backlight
        dest: /usr/bin/backlight
        owner: root
        group: root
        mode: u+sx,g+sx,o+sx
      become: true
    - name: Change the splash screen so it shows only text
      shell: plymouth-set-default-theme details -R
      become: true
# -- Emacs ---------------------------------------------------------------------
  - name: Emacs
    when: workstation
    block:
    - name: Install Emacs
      dnf:
        name: emacs
        state: present
      become: true
    - name: Enable Emacs as a daemon
      systemd:
        name: emacs
        state: started
        enabled: true
        scope: user
    - name: Fetch Doom Emacs repo
      git:
        repo: https://github.com/hlissner/doom-emacs.git
        dest: ~/.emacs.d
        depth: 1
    - name: Install Doom Emacs
      shell: yes | ~/.emacs.d/bin/doom install
    - name: Apply Doom Emacs config.el
      template:
        src: ./emacs/config.el.j2
        dest: ~/.doom.d/config.el
    - name: Apply Doom Emacs init.el
      copy:
        src: ./emacs/init.el
        dest: ~/.doom.d/init.el
    - name: Apply Doom Emacs packages.el
      copy:
        src: ./emacs/packages.el
        dest: ~/.doom.d/packages.el
    - name: Sync Doom Emacs configuration
      shell: yes | ~/.emacs.d/bin/doom sync
    - name: Install cmake for terminal plugin
      dnf:
        name: cmake
        state: present
      become: true
    - name: Install Iosevka SS05 fonts
      block:
      - name: Install unzip to be able to extract downloaded fonts
        dnf:
          name: unzip
          state: present
        become: true
      - name: Download Iosevka fonts into system fonts directory
        unarchive:
          src: https://github.com/be5invis/Iosevka/releases/download/v3.6.3/pkg-iosevka-ss05-3.6.3.zip
          dest: /usr/share/fonts
          remote_src: yes
        become: true
      - name: Refresh system fonts
        shell: fc-cache
# -- Pcmanfm -------------------------------------------------------------------
# -- Utils ---------------------------------------------------------------------
# pavucontrol-qt
# filezilla
# keepassx
# steam
# -- Firefox -------------------------------------------------------------------
# For now, just copy .config/firefox with everything
